<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Detect Waste - EcoSort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { background-color: #121212; color: #f0f0f0; }
    .navbar { background-color: #1f1f1f; }
    .navbar a { color: white !important; }
    .card {
      background-color: #1e1e1e;
      border: 1px solid #333;
      color: #ffffff;
    }
    .form-control, .btn {
      background-color: #2b2b2b;
      color: white;
      border: 1px solid #444;
    }
    .form-control::file-selector-button {
      background-color: #007bff;
      color: white;
      border: none;
    }
    .alert-info {
      background-color: #0d6efd33;
      border: none;
      color: #a9c9ff;
    }
    .text-success { color: #00e676 !important; }
    .text-danger { color: #ff5252 !important; }
    .error-msg {
      color: #ff5252;
      font-size: 0.95rem;
      margin-top: 5px;
    }
    img {
      max-width: 100%;
      height: auto;
    }

    .navbar {
      background-color: #1f1f1f;
    }

    .navbar a {
      color: white !important;
    }

    .navbar .nav-link.active {
      font-weight: bold;
      color: #00e676 !important;
    }

    .navbar-toggler {
      border: none;
    }

    .navbar-toggler-icon {
      background-color: white;
      -webkit-mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      mask-repeat: no-repeat;
      mask-position: center;
      width: 30px;
      height: 30px;
    }

    .chart-container {
      width: 100%;
      height: 250px; /* fixed height to prevent squishing */
      position: relative;
    }

    @media (max-width: 576px) {
      .chart-container {
        height: 220px; /* slightly smaller for very narrow screens */
      }
    }
  </style>

</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<body>

{% include 'navbar.html' %}

<div class="container py-5">
  <div class="card p-4 shadow mb-4 mx-auto" style="max-width: 600px;">
    <h2 class="text-center mb-4">Upload Waste Image</h2>
    <form action="/predict" method="POST" enctype="multipart/form-data" onsubmit="return validateFile()">
      <input type="file" id="fileInput" class="form-control mb-2" name="file" accept=".jpg,.jpeg,.png" required>
      <div id="errorMsg" class="error-msg"></div>
      <button type="submit" class="btn btn-success w-100 mt-2">Classify</button>
    </form>
  </div>

  {% if label %}
  <div class="card p-4 shadow mb-4 mx-auto" style="max-width: 700px;">
    <h3 class="text-primary text-center">{{ label }}</h3>
    <p class="text-center">Confidence: <strong>{{ confidence }}%</strong></p>
    <p class="text-center">Waste Type: 
      <strong class="text-{{ 'success' if category == 'Biodegradable' else 'danger' }}">
        {{ category }}
      </strong>
    </p>
    <div class="text-center mb-3">
      <img src="{{ url_for('uploaded_file', filename=image_path) }}" class="img-fluid rounded">
    </div>
    <div class="alert alert-info text-center">
      <strong>Recycling Tip:</strong> {{ tip }}
    </div>
  </div>

  <div class="card p-4 shadow mx-auto" style="max-width: 700px;">
    <h5 class="text-center mb-3">Prediction Confidence Chart</h5>
    <div class="chart-container">
      <canvas id="probChart"></canvas>
    </div>
  </div>
  {% endif %}
</div>

<script>
function validateFile() {
  const fileInput = document.getElementById('fileInput');
  const errorMsg = document.getElementById('errorMsg');
  const file = fileInput.files[0];
  const allowedTypes = ['image/jpeg', 'image/png'];

  if (file && !allowedTypes.includes(file.type)) {
    errorMsg.textContent = "Only JPEG and PNG images are allowed.";
    return false;
  }

  errorMsg.textContent = "";
  return true;
}
</script>

{% if probabilities %}
<script>
const ctx = document.getElementById('probChart').getContext('2d');
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: {{ labels|tojson }},
    datasets: [{
      label: 'Confidence',
      data: {{ probabilities|tojson }},
      backgroundColor: ['#4CAF50', '#FF9800', '#03A9F4', '#F44336', '#9C27B0', '#FFEB3B'],
      borderRadius: 6,
      borderSkipped: false
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#333',
        titleColor: '#fff',
        bodyColor: '#eee',
        borderColor: '#555',
        borderWidth: 1
      }
    },
    scales: {
      x: {
        ticks: { color: '#ccc' },
        grid: { color: '#444' }
      },
      y: {
        beginAtZero: true,
        max: 1,
        ticks: {
          stepSize: 0.2,  
          color: '#ccc',
          callback: function(value) {
            return (value * 100).toFixed(0) + '%';
          }
        },
        grid: { color: '#444' }
      }
    }
  }
});
</script>
{% endif %}

</body>
</html>
